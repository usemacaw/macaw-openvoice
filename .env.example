# Macaw OpenVoice — Environment Variables
#
# Copy to `.env` for local development. All values shown are defaults.
# See: macaw/config/settings.py for validation rules.

# ─── Server ───────────────────────────────────────────────────
# API server bind address.
# MACAW_HOST=127.0.0.1

# API server HTTP port (1–65535).
# MACAW_PORT=8000

# Maximum audio upload size in megabytes (1–500).
# MACAW_MAX_FILE_SIZE_MB=25

# Retry-After header value for 503/502 responses (seconds, sent as string).
# MACAW_RETRY_AFTER_S=5

# Comma-separated allowed CORS origins. Empty = no CORS.
# Set to "*" for development; use specific origins in production.
# CLI --cors-origins flag overrides this value.
# MACAW_CORS_ORIGINS=

# ─── WebSocket ────────────────────────────────────────────────
# Maximum binary frame size in bytes (min 1024).
# MACAW_MAX_WS_FRAME_SIZE_BYTES=1048576

# Inactivity timeout before closing the WebSocket session (seconds, >0).
# MACAW_WS_INACTIVITY_TIMEOUT_S=60.0

# Heartbeat ping interval (seconds, >0, must be < inactivity timeout).
# MACAW_WS_HEARTBEAT_INTERVAL_S=10.0

# Interval for checking inactivity (seconds, >0).
# MACAW_WS_CHECK_INTERVAL_S=5.0

# ─── TTS ──────────────────────────────────────────────────────
# Timeout for the gRPC Synthesize RPC (seconds, >0).
# MACAW_TTS_GRPC_TIMEOUT_S=60.0

# Timeout for the gRPC ListVoices RPC (seconds, >0).
# MACAW_TTS_LIST_VOICES_TIMEOUT_S=10.0

# TTS streaming chunk size in bytes (512–65536).
# 4096 = ~85ms at 24kHz. Smaller = lower TTFB, more overhead.
# MACAW_TTS_CHUNK_SIZE_BYTES=4096

# Maximum text length for TTS synthesis (1–1000000).
# Increase for audiobook/long-form content generation.
# MACAW_TTS_MAX_TEXT_LENGTH=4096

# ─── Workers ──────────────────────────────────────────────────
# Directory where models are installed (supports ~).
# MACAW_MODELS_DIR=~/.macaw/models

# First gRPC port for worker subprocesses (1024–65535).
# MACAW_WORKER_BASE_PORT=50051

# Hostname for gRPC worker connections. Change for distributed deployments
# (Docker Compose, Kubernetes) where workers run on separate hosts.
# MACAW_WORKER_HOST=localhost

# Maximum concurrent inference requests per STT worker (1–16).
# Increase for GPU with spare capacity; keep 1 for consumer GPUs.
# MACAW_STT_WORKER_MAX_CONCURRENT=1

# Accumulation threshold for streaming STT inference (seconds, >0, max 30).
# Audio is accumulated until this duration before running inference.
# Lower = more responsive partials, higher = better accuracy.
# Can be overridden per-model via engine_config in macaw.yaml.
# MACAW_STT_ACCUMULATION_THRESHOLD_S=5.0

# Upper bound for tracking cancelled requests in STT worker (100–1000000).
# Prevents unbounded memory growth under cancellation storms.
# MACAW_STT_MAX_CANCELLED_REQUESTS=10000

# ─── VAD (Voice Activity Detection) ──────────────────────────
# Sensitivity preset — controls energy + silero thresholds together.
# HIGH = detects whispers (banking, quiet rooms).
# NORMAL = standard conversation (default).
# LOW = noisy environments (call centers, factories).
# MACAW_VAD_SENSITIVITY=normal

# Minimum consecutive speech before emitting SPEECH_START (ms, 50–5000).
# MACAW_VAD_MIN_SPEECH_DURATION_MS=250

# Minimum consecutive silence before emitting SPEECH_END (ms, 50–5000).
# MACAW_VAD_MIN_SILENCE_DURATION_MS=300

# Maximum continuous speech before forced SPEECH_END (ms, 1000–600000).
# Increase for long monologues; decrease for quick turn-taking.
# MACAW_VAD_MAX_SPEECH_DURATION_MS=30000

# Override energy pre-filter dBFS threshold, bypassing sensitivity preset.
# Useful for fine-tuning beyond HIGH/NORMAL/LOW presets (-80 to 0).
# MACAW_VAD_ENERGY_THRESHOLD_DBFS=

# Override Silero VAD speech probability threshold (0.0–1.0 exclusive).
# Lower = more sensitive (catches whispers), higher = stricter.
# MACAW_VAD_SILERO_THRESHOLD=

# ─── Worker Lifecycle ─────────────────────────────────────────
# Max crash count before giving up on a worker (1–100).
# MACAW_WORKER_MAX_CRASHES=3

# Time window for counting crashes (seconds, >0, max 3600).
# MACAW_WORKER_CRASH_WINDOW_S=60.0

# First health probe delay after spawn (seconds, >0, max 60).
# Must be < MACAW_WORKER_HEALTH_PROBE_MAX_DELAY_S.
# MACAW_WORKER_HEALTH_PROBE_INITIAL_DELAY_S=0.5

# Maximum delay between health probe retries (seconds, >0, max 300).
# MACAW_WORKER_HEALTH_PROBE_MAX_DELAY_S=5.0

# Total timeout waiting for a worker to become healthy (seconds, >0, max 600).
# Increase for large models that take long to load (e.g., Whisper large-v3).
# MACAW_WORKER_HEALTH_PROBE_TIMEOUT_S=120.0

# Interval between process-alive checks (seconds, >0, max 60).
# MACAW_WORKER_MONITOR_INTERVAL_S=1.0

# Grace period for gRPC server.stop() before SIGKILL (seconds, >0, max 60).
# MACAW_WORKER_STOP_GRACE_PERIOD_S=5.0

# Number of warmup inference passes at worker startup (0–20).
# Set to 0 to skip warmup (faster startup, slower first request).
# MACAW_WORKER_WARMUP_STEPS=3

# Timeout for each health probe gRPC call (seconds, >0, max 30).
# Increase for high-latency networks (VPN, cross-region).
# MACAW_WORKER_HEALTH_PROBE_RPC_TIMEOUT_S=2.0

# ─── gRPC ─────────────────────────────────────────────────────
# Max gRPC message size for batch (REST) requests in MB (1–500).
# Must be >= MACAW_MAX_FILE_SIZE_MB to accept the largest uploads.
# MACAW_GRPC_MAX_BATCH_MESSAGE_MB=30

# Max gRPC message size for streaming (WebSocket) frames in MB (1–100).
# MACAW_GRPC_MAX_STREAMING_MESSAGE_MB=10

# ─── Session (Streaming STT) ─────────────────────────────────
# Ring buffer duration for audio recovery/replay (seconds, >0, max 600).
# Longer = more audio available for recovery after worker crash.
# MACAW_SESSION_RING_BUFFER_DURATION_S=60.0

# Timeout for worker recovery after crash (seconds, >0, max 120).
# Increase for slow workers or large model reloads.
# MACAW_SESSION_RECOVERY_TIMEOUT_S=10.0

# Timeout for draining final transcripts from the worker stream (seconds, >0, max 60).
# MACAW_SESSION_DRAIN_STREAM_TIMEOUT_S=5.0

# Timeout for the final flush-and-close on session end (seconds, >0, max 30).
# MACAW_SESSION_FLUSH_AND_CLOSE_TIMEOUT_S=2.0

# Maximum audio backlog before dropping frames (seconds, >0, max 120).
# Lower = more aggressive dropping; higher = more tolerant of bursts.
# MACAW_SESSION_BACKPRESSURE_MAX_BACKLOG_S=10.0

# Audio rate above which backpressure kicks in (>1.0, max 5.0).
# 1.2 = allow up to 120% of real-time before rate-limiting.
# MACAW_SESSION_BACKPRESSURE_RATE_LIMIT_THRESHOLD=1.2

# Timeout waiting for first audio in INIT state (seconds, 1–600).
# If no audio arrives within this timeout, session transitions to CLOSED.
# MACAW_SESSION_INIT_TIMEOUT_S=30.0

# Timeout for silence after speech ends (seconds, 1–600).
# After this duration of silence, session transitions to HOLD.
# MACAW_SESSION_SILENCE_TIMEOUT_S=30.0

# Timeout for prolonged silence in HOLD state (seconds, 1–3600).
# After this duration in HOLD, session transitions to CLOSING.
# Increase for applications where long pauses are expected.
# MACAW_SESSION_HOLD_TIMEOUT_S=300.0

# Timeout for flushing pending transcripts in CLOSING state (seconds, 1–60).
# MACAW_SESSION_CLOSING_TIMEOUT_S=2.0

# Ring buffer uncommitted data threshold that triggers force commit (0.5–1.0).
# 0.90 = force commit when 90% of ring buffer contains uncommitted data.
# Lower = more frequent commits (safer but more overhead).
# MACAW_SESSION_RING_BUFFER_FORCE_COMMIT_THRESHOLD=0.90

# Maximum tokens for cross-segment context conditioning (1–2048).
# 224 = half of Whisper's 448-token context window. Increase for larger models.
# Only affects encoder-decoder engines (Whisper); CTC ignores this.
# MACAW_SESSION_CROSS_SEGMENT_MAX_TOKENS=224

# ─── Scheduler ────────────────────────────────────────────────
# Minimum gRPC timeout for TranscribeFile, regardless of audio length
# (seconds, >0, max 600).
# MACAW_SCHEDULER_MIN_GRPC_TIMEOUT_S=30.0

# Multiplier applied to estimated audio duration to compute gRPC timeout.
# timeout = max(min_grpc_timeout, audio_duration * factor).
# MACAW_SCHEDULER_TIMEOUT_FACTOR=2.0

# Timeout for draining in-flight requests during graceful shutdown
# (seconds, >0, max 120).
# MACAW_SCHEDULER_SHUTDOWN_TIMEOUT_S=10.0

# Time before a BATCH request is promoted to REALTIME priority
# (seconds, >0, max 300). Prevents starvation under load.
# MACAW_SCHEDULER_AGING_THRESHOLD_S=30.0

# Accumulation window for batching consecutive BATCH requests (ms, >0, max 5000).
# Lower = less latency, higher = better throughput.
# MACAW_SCHEDULER_BATCH_ACCUMULATE_MS=50.0

# Maximum number of requests per batch (1–64).
# MACAW_SCHEDULER_BATCH_MAX_SIZE=8

# Backoff when no worker is available for dispatch (seconds, >0, max 10).
# MACAW_SCHEDULER_NO_WORKER_BACKOFF_S=0.1

# Poll interval for dequeuing from the priority queue (seconds, >0, max 10).
# Trade-off: shorter = lower latency but more CPU wake-ups.
# MACAW_SCHEDULER_DEQUEUE_POLL_INTERVAL_S=0.5

# Interval for cleaning up expired latency tracker entries (seconds, >0, max 600).
# MACAW_SCHEDULER_LATENCY_CLEANUP_INTERVAL_S=30.0

# TTL for latency tracker entries (seconds, >0, max 600).
# Entries older than this are removed to prevent memory leaks.
# MACAW_SCHEDULER_LATENCY_TTL_S=60.0

# Timeout for gRPC cancel propagation to workers (seconds, >0, max 10).
# Best-effort: if worker doesn't respond in time, cancel is abandoned.
# MACAW_SCHEDULER_CANCEL_PROPAGATION_TIMEOUT_S=0.1

# ─── CLI ──────────────────────────────────────────────────────
# Server URL used by `macaw transcribe` / `macaw translate` commands.
# MACAW_SERVER_URL=http://localhost:8000

# HTTP request timeout for CLI commands (seconds, >0).
# MACAW_HTTP_TIMEOUT_S=120.0

# ─── Preprocessing ──────────────────────────────────────────
# DC-remove high-pass filter cutoff frequency in Hz (1–500).
# 20Hz for full-band audio; increase to 80Hz+ for telephony.
# MACAW_PREPROCESSING_DC_CUTOFF_HZ=20

# Gain normalization target peak level in dBFS (-60 to 0).
# -3.0 dBFS = industry standard headroom. Lower for quieter output.
# MACAW_PREPROCESSING_TARGET_DBFS=-3.0

# ─── Post-Processing ───────────────────────────────────────
# Default language for Inverse Text Normalization (ITN).
# Used as fallback when STT does not detect a language.
# Must match a language supported by nemo_text_processing.
# MACAW_ITN_DEFAULT_LANGUAGE=pt
# Legacy alias (still works): MACAW_ITN_LANGUAGE=pt

# ─── Codec ───────────────────────────────────────────────────
# Opus encoder target bitrate in bits/s (6000–512000).
# Higher = better quality, more bandwidth. 64000 is good for speech.
# MACAW_CODEC_OPUS_BITRATE=64000

# ─── Logging (read directly by macaw/logging.py, NOT via Settings) ──
# Log format: "console" (human-readable) or "json" (structured).
# MACAW_LOG_FORMAT=console

# Log level: DEBUG, INFO, WARNING, ERROR.
# MACAW_LOG_LEVEL=INFO
