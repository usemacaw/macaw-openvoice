# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- `CodecError` and `CodecUnavailableError` exceptions for fail-fast codec validation (#gap-analysis-ws2)
- `is_codec_available()` pre-flight check function in codec factory (#gap-analysis-ws2)
- `hot_words` Form parameter in `POST /v1/audio/transcriptions` and `POST /v1/audio/translations` REST routes — hot words are parsed and forwarded to scheduler (#gap-analysis-ws4)
- `timestamp_granularities` Form parameter in `POST /v1/audio/translations` route — previously missing, now matches transcriptions route (#gap-analysis-ws4)
- `PUT /v1/voices/{voice_id}` endpoint for editing saved voice metadata (name, language, ref_text, instruction) (#gap-analysis-ws4)
- `VoiceStore.update()` abstract method and `FileSystemVoiceStore` implementation for partial voice metadata updates (#gap-analysis-ws4)
- `MuteController.mute_depth` property for reference count debugging (#gap-analysis-ws5)
- `Mp3Encoder` codec via lameenc for MP3 output format (#gap-analysis-ws3)
- `MuLawEncoder` and `ALawEncoder` (pure numpy) for G.711 telephony codecs (#gap-analysis-ws3)
- `resample_output()` DSP primitive for sample rate conversion (#gap-analysis-ws3)
- `response_format` options: `mp3`, `mulaw`, `alaw` in REST and WebSocket TTS endpoints (#gap-analysis-ws3)

### Changed
- `OpusEncoder.encode()` and `flush()` raise `CodecUnavailableError` instead of silently returning raw PCM when opuslib is not installed (fail-open to fail-fast) (#gap-analysis-ws2)
- `create_encoder()` raises `CodecUnavailableError` for unknown codecs instead of returning `None` (#gap-analysis-ws2)
- `MuteController` uses reference counting (`_mute_count: int`) instead of boolean flag — supports concurrent TTS contexts without mute/unmute interference (#gap-analysis-ws5)
- `POST /v1/audio/speech` validates codec availability before opening gRPC stream — returns 400 for unavailable codecs (#gap-analysis-ws2)
- WebSocket `tts.speak` validates codec availability before spawning TTS task — sends error event for unavailable codecs (#gap-analysis-ws2)

### Fixed
- Factual errors in gap analysis review meeting minutes — corrected Voice Changer priority change, ulaw/alaw promotion, line reference, evidence count (#gap-analysis-ws0)
- False positive test `test_hot_words_in_batch_result_both_engines` marked as xfail — Form fields silently ignored by FastAPI, not actually wired (#gap-analysis-ws0)
- Missing `ACTIVE -> CLOSING` transition in `SessionState` docstring — existed in state_machine.py but was undocumented in the enum (#gap-analysis-ws0)
- Stale alignment assertions in ADR-008 — updated to reflect completed implementation status (word/character/normalized alignment) (#gap-analysis-ws1)

- `--voice-dir` CLI option and `MACAW_VOICE_DIR` env var to enable voice persistence in `macaw serve` — operators can now configure a directory for Voice CRUD without code changes (#voice-store-wiring)
- API Examples documentation page (`docs/docs/guides/api-examples.mdx`) — complete request/response reference for all REST endpoints, WebSocket protocol, voice CRUD, audio effects, alignment, and error handling with real captured outputs (#docs)

### Changed
- Rewritten `docs/ADDING_ENGINE.md` with complete TTS/STT backend examples, import guard pattern, executor pattern, error handling guidance, shared utilities reference, and verification checklist (#engine-extensibility)
- Rewritten `docs/docs/guides/adding-engine.mdx` (Docusaurus public guide) to match actual codebase — fixes 21 issues including wrong file paths, wrong imports, wrong method signatures, missing required patterns, and stale manifest schema (#engine-extensibility)

### Added
- Validation notebooks for pre-release regression testing on Google Colab — `validate_cli.ipynb` (48 cells, all CLI commands) and `validate_api.ipynb` (81 cells, REST + WebSocket + error handling) with round-trip TTS-to-STT verification (#validation)
- Qwen3-ASR-0.6B STT backend with 52-language support, auto-detection, and word timestamps — encoder-decoder architecture with runtime LocalAgreement for streaming (#engine-catalog)
- Chatterbox Turbo TTS backend with voice cloning via reference audio and configurable sampling parameters (temperature, top_p, top_k, repetition_penalty) (#engine-catalog)
- Dynamic external engine loading via `python_package` manifest field — external STT/TTS backends are loaded automatically via `importlib` without modifying runtime code (#engine-extensibility)
- `python_package` field on `ModelManifest` with dotted-module-path validation — external engines declare their Python entry point in `macaw.yaml` (#engine-extensibility)
- `load_external_backend()` helper in `macaw/workers/_engine_loader.py` — discovers the single concrete subclass of `STTBackend`/`TTSBackend` in an external module (#engine-extensibility)
- `--python-package` CLI argument for STT and TTS worker subprocesses — enables dynamic engine loading from manifest through the worker lifecycle (#engine-extensibility)
- `ModelCapabilities(extra="forbid")` — unknown capability fields in `macaw.yaml` are now rejected at scan time instead of silently ignored (#engine-extensibility)
- Registry scan warning for unknown engines without `python_package` — warns about engines not in `ENGINE_PACKAGE` that may fail to start (#engine-extensibility)
- `is_engine_available()` now checks external package importability when `python_package` is set (#engine-extensibility)
- TTS word-level alignment — Kokoro backend extracts native per-token timing from `MToken.start_ts/end_ts` at zero extra latency cost, streamed alongside audio via `ChunkAlignment` proto messages (#tts-alignment)
- `synthesize_with_alignment()` method on `TTSBackend` ABC — non-abstract default wraps `synthesize()` for engines without native alignment; Kokoro overrides with timing extraction (#tts-alignment)
- `include_alignment` and `alignment_granularity` fields in gRPC `SynthesizeRequest` — opt-in alignment with backward-compatible proto field numbers 11-12 (#tts-alignment)
- `AlignmentItem` and `ChunkAlignment` proto messages in `tts_worker.proto` — per-chunk alignment data streamed in `SynthesizeChunk` (#tts-alignment)
- `TTSAlignmentItem` and `TTSChunkResult` dataclasses in `macaw/_types.py` — runtime alignment types (#tts-alignment)
- `supports_alignment` and `supports_character_alignment` fields on `TTSEngineCapabilities` (#tts-alignment)
- `include_alignment` and `alignment_granularity` fields on `SpeechRequest` — REST clients opt into NDJSON alignment response (#tts-alignment)
- NDJSON streaming for alignment mode in `POST /v1/audio/speech` — when `include_alignment=true`, response is `application/x-ndjson` with base64-encoded audio + per-word timing per chunk, plus a `done` marker with accumulated duration (#tts-alignment)
- Alignment response models (`AlignmentItemResponse`, `ChunkAlignmentResponse`, `AudioChunkWithAlignment`, `AlignmentStreamDone`) in `macaw/server/models/alignment.py` (#tts-alignment)
- `tts.alignment` WebSocket event — per-word/character timing sent as JSON text frame before each binary audio chunk when `include_alignment=true` in `tts.speak` command (#tts-alignment)
- `TTSAlignmentEvent` and `TTSAlignmentItemEvent` models in events.py, added to `ServerEvent` union (#tts-alignment)
- `include_alignment` and `alignment_granularity` fields on `TTSSpeakCommand` for WebSocket alignment opt-in (#tts-alignment)
- `seed` parameter for reproducible TTS generation — Qwen3 calls `torch.manual_seed()` before generation; Kokoro logs info (deterministic engine, no-op) (#tts-alignment)
- `text_normalization` parameter (`auto`/`on`/`off`) — controls engine text normalization; `off` adds normalization-bypass instruction for LLM-based engines (#tts-alignment)
- `temperature`, `top_k`, `top_p` sampling parameters for LLM-based TTS engines (Qwen3-TTS) — forwarded as `**generate_kwargs` to model generation methods (#tts-alignment)
- Proto fields `seed`, `text_normalization`, `temperature`, `top_k`, `top_p` on `SynthesizeRequest` (backward-compatible field numbers 13-17) (#tts-alignment)
- Forced alignment fallback module (`macaw/alignment/`) — CTC-based forced alignment using wav2vec2 + `torchaudio.functional.forced_align` for TTS engines without native alignment support (e.g., Qwen3-TTS) (#tts-alignment)
- `Aligner` ABC in `macaw/alignment/interface.py` and `CTCAligner` implementation in `macaw/alignment/ctc_aligner.py` — lazy-loads wav2vec2 model on first use, runs in worker subprocess (#tts-alignment)
- `create_aligner()` factory with torchaudio import guard — graceful degradation when torchaudio unavailable (#tts-alignment)
- TTS servicer capability check for alignment — dispatches to native alignment or forced alignment fallback based on `TTSEngineCapabilities.supports_alignment` (#tts-alignment)
- Character-level alignment for Kokoro — `alignment_granularity=character` distributes word-level timing uniformly across characters via `_distribute_timing_to_chars()` helper (#tts-alignment)
- Normalized alignment (phoneme-based) — Kokoro extracts phoneme timing from `MToken.phonemes`, propagated through proto (`normalized_alignment` field 6 on `SynthesizeChunk`), REST NDJSON, and WebSocket `tts.alignment` events (#tts-alignment)
- `normalized_alignment` field on `TTSChunkResult`, `AudioChunkWithAlignment`, and `TTSAlignmentEvent.normalized_items` — full pipeline support for both grapheme and phoneme alignment data (#tts-alignment)
- `alignment` optional dependency group in pyproject.toml (`torchaudio>=2.1`) (#tts-alignment)
- Audio effects layer (`macaw/audio_effects/`) with `AudioEffect` ABC, `AudioEffectChain` compositor, and factory function `create_effect_chain()` — post-synthesis audio transformations applied server-side before transport (#audio-effects)
- `PitchShiftEffect` for frequency shifting via time-axis interpolation, supports +/-12 semitones (#audio-effects)
- `ReverbEffect` implementing Freeverb algorithm (8 comb filters + 4 allpass filters) with configurable room size, damping, and wet/dry mix (#audio-effects)
- `effects` field in `POST /v1/audio/speech` request body and `tts.speak` WebSocket command — clients can request pitch shift and reverb on TTS output (#audio-effects)
- `AudioEffectsParams` Pydantic model with validated ranges for all effect parameters (#audio-effects)
- `EffectsSettings` configuration group with `MACAW_EFFECTS_PITCH_SHIFT_MAX_SEMITONES` environment variable (#audio-effects)
- `pcm16_bytes_to_float32()` utility for PCM16 bytes to float32 conversion (inverse of `float32_to_pcm16_bytes`) (#audio-effects)
- Multi-language ITN support — `ITNStage` maintains per-language normalizer cache, `TextStage.process()` accepts optional `language` parameter, detected language from STT flows automatically to post-processing (#32)
- Environment variable `MACAW_ITN_DEFAULT_LANGUAGE` (replaces `MACAW_ITN_LANGUAGE` which remains as backward-compatible alias) (#32)
- Runtime codec layer (`macaw/codec/`) with `CodecEncoder` ABC and `OpusEncoder` — engine-agnostic audio encoding injected between TTS backend and transport layer (#32)
- `response_format=opus` support in `POST /v1/audio/speech` for Opus-encoded TTS output (#32)
- `codec` field in `tts.speak` WebSocket command for Opus-encoded TTS streaming (#32)
- `MACAW_CODEC_OPUS_BITRATE` environment variable for Opus encoder bitrate configuration (#32)
- `ISTFTCache` class in `macaw/_dsp.py` — pre-computed overlap-add buffers for streaming iSTFT, infrastructure for future vocoder-based TTS engines (#32)
- Centralized DSP module (`macaw/_dsp.py`) with window functions, STFT/iSTFT, and mel filterbank — pure signal processing primitives for future vocoder and feature extraction engines (#32)
- DSP constants `DEFAULT_FFT_SIZE`, `DEFAULT_HOP_LENGTH`, `DEFAULT_N_MELS` in `_audio_constants.py` (#32)
- `post_load_hook()` optional lifecycle method in `TTSBackend` and `STTBackend` ABCs — engines can override to load auxiliary models (vocoder, speaker embeddings) after main model load, before warmup (#32)
- Environment variable `MACAW_SESSION_CROSS_SEGMENT_MAX_TOKENS` — configurable cross-segment context window size, operators can tune per model (Whisper default 224 = half of 448-token window) (#32)
- Environment variable `MACAW_VAD_SILERO_THRESHOLD` — optional override for Silero VAD speech probability threshold, decoupled from sensitivity presets for fine-grained tuning (#32)
- Cross-segment context now wired in production WebSocket sessions — `_create_streaming_session` passes `CrossSegmentContext` to `StreamingSession` (#32)
- Environment variable `MACAW_STT_MAX_CANCELLED_REQUESTS` — configurable upper bound for cancelled request tracking in STT worker, prevents unbounded memory growth under cancellation storms (#32)
- Environment variable `MACAW_VAD_ENERGY_THRESHOLD_DBFS` — optional override for energy pre-filter dBFS threshold, decoupled from sensitivity presets for fine-grained tuning (#32)
- Centralized `DEFAULT_SPECTRAL_FLATNESS_THRESHOLD` in `_audio_constants.py` — single source of truth for spectral flatness threshold used by VAD energy pre-filter (#32)
- Centralized `MANIFEST_FILENAME` constant in `config/manifest.py` — eliminates 5x scattered `"macaw.yaml"` string literals across registry and downloader (#32)
- Shared `get_inference_context()` helper in `workers/torch_utils.py` — eliminates duplicated try/except torch.inference_mode() pattern across TTS backends (#32)
- Environment variable `MACAW_CORS_ORIGINS` for CORS configuration via env var — operators in Docker/K8s can set CORS without modifying CLI invocation (#32)
- Environment variables for session state machine timeouts: `MACAW_SESSION_INIT_TIMEOUT_S`, `MACAW_SESSION_SILENCE_TIMEOUT_S`, `MACAW_SESSION_HOLD_TIMEOUT_S`, `MACAW_SESSION_CLOSING_TIMEOUT_S` — operators can tune session lifecycle timeouts per deployment (#32)
- Environment variable for ring buffer force commit threshold: `MACAW_SESSION_RING_BUFFER_FORCE_COMMIT_THRESHOLD` — tune uncommitted data threshold before automatic commit (#32)
- Environment variable for STT accumulation threshold: `MACAW_STT_ACCUMULATION_THRESHOLD_S` — global default for streaming inference accumulation window, overridable per-model via engine_config (#32)
- Environment variable for TTS max text length: `MACAW_TTS_MAX_TEXT_LENGTH` — increase for audiobook/long-form content generation (#32)
- Environment variables for audio preprocessing tuning: `MACAW_PREPROCESSING_DC_CUTOFF_HZ`, `MACAW_PREPROCESSING_TARGET_DBFS` — operators can tune DC-remove cutoff (telephony vs full-band) and gain normalization target per deployment (#hardcode-audit-v6)
- Environment variable for ITN language: `MACAW_ITN_LANGUAGE` — multi-language deployments can switch ITN language without code changes (#hardcode-audit-v6)
- Environment variable for TTS streaming chunk size: `MACAW_TTS_CHUNK_SIZE_BYTES` — tune TTFB vs network overhead trade-off (#hardcode-audit-v6)
- Environment variable for STT worker concurrency: `MACAW_STT_WORKER_MAX_CONCURRENT` — increase for GPUs with spare capacity (#hardcode-audit-v6)
- Environment variable for health probe RPC timeout: `MACAW_WORKER_HEALTH_PROBE_RPC_TIMEOUT_S` — tune for high-latency networks (#hardcode-audit-v6)
- Centralized constants: `SILERO_VAD_CHUNK_SIZE`, `PCM_UINT8_SCALE` in `_audio_constants.py`; `MIN_REALTIME_RTF` in `workers/_constants.py` (#hardcode-audit-v6)
- VAD sensitivity and debounce durations configurable via environment variables: `MACAW_VAD_SENSITIVITY`, `MACAW_VAD_MIN_SPEECH_DURATION_MS`, `MACAW_VAD_MIN_SILENCE_DURATION_MS`, `MACAW_VAD_MAX_SPEECH_DURATION_MS` (#hardcode-audit-v5)
- Worker gRPC host configurable via `MACAW_WORKER_HOST` for distributed deployments (Docker Compose, K8s) (#hardcode-audit-v5)
- Environment variables for worker lifecycle tuning: `MACAW_WORKER_MAX_CRASHES`, `MACAW_WORKER_CRASH_WINDOW_S`, `MACAW_WORKER_HEALTH_PROBE_TIMEOUT_S`, `MACAW_WORKER_STOP_GRACE_PERIOD_S`, `MACAW_WORKER_WARMUP_STEPS`, and others (#env-configurability)
- Environment variables for gRPC message size: `MACAW_GRPC_MAX_BATCH_MESSAGE_MB`, `MACAW_GRPC_MAX_STREAMING_MESSAGE_MB` (#env-configurability)
- Environment variables for scheduler tuning: `MACAW_SCHEDULER_MIN_GRPC_TIMEOUT_S`, `MACAW_SCHEDULER_AGING_THRESHOLD_S`, `MACAW_SCHEDULER_BATCH_MAX_SIZE`, and others (#env-configurability)
- Centralized `pydantic-settings` configuration (`macaw/config/settings.py`) — all 14 `MACAW_*` env vars validated, typed, and documented in `.env.example`; replaces scattered `os.environ.get()` calls across 4 modules (#settings)
- `NullMetric` null object class (`macaw/_null_metrics.py`) — metrics consumers call methods unconditionally without guard checks, NullMetric silently discards observations when prometheus_client is not installed (#review-v3-4.4)
- OpenAPI tags on all routers — Audio, Voices, System, Realtime — Swagger UI now groups endpoints by category (#review-v3-4.5)
- OpenAPI tag presence tests in `test_openapi_schema.py` (#review-v3-4.5)
- Partial failure tracking in `GET /v1/voices` — failed models are logged with `voices_partial_response` warning including model names and returned count (#review-v3-4.10)
- `timestamp_granularities[]` Form parameter in `POST /v1/audio/transcriptions` — clients can now request word-level timestamps via the REST API (#review-v2-F07)
- `language` field to `AudioFrame` proto — streaming sessions can now specify language instead of always auto-detecting (#review-v2-F27)
- `current_timeouts` read-only property on `StreamingSession` for timeout introspection (#review-v2-F12)
- OpenAPI schema structural test — guards against accidental endpoint or parameter removal during refactoring (#review-v2-F26)
- `TTSEngineError` exception for server-side TTS failures (GPU OOM, empty audio), sibling of `TTSSynthesisError` for client errors (#review-v2-F19)
- `ServiceNotConfiguredError` typed exception replacing generic `RuntimeError` in FastAPI dependency injection (#review-v2-F21)
- `TranscribeFileParams` frozen dataclass replacing untyped `dict[str, object]` return from proto converter (#review-v2-F09)
- `type` and `engine` fields to `GET /v1/models` response for richer model listing (#review-v2)
- Pre-commit hooks for local quality enforcement: ruff, bandit SAST, detect-secrets, file hygiene, branch protection (#quality-gates)
- Test coverage measurement with pytest-cov — branch coverage enabled, `fail_under = 70` (#quality-gates)
- Bandit SAST security scanning as Make target and CI step (#quality-gates)
- New Makefile targets: `test-cov`, `security`, `audit` (#quality-gates)
- Coverage reporting with HTML artifacts and XML upload in CI pipeline (#quality-gates)

### Changed
- Renamed `TTSAlignmentItem` Pydantic model in events.py to `TTSAlignmentItemEvent` to avoid name collision with `macaw._types.TTSAlignmentItem` dataclass (#tts-alignment-review)
- `TTSSpeakCommand` sampling params (`temperature`, `top_k`, `top_p`) now validated with `Field(ge=, le=)` constraints matching `SpeechRequest` (#tts-alignment-review)
- `alignment_granularity` tightened from `str` to `Literal["word", "character"]` across all Python types (`TTSChunkResult`, `SynthesizeParams`, `TTSAlignmentEvent`, `ChunkAlignmentResponse`, `build_tts_proto_request`) (#tts-alignment-review)
- Proto3 zero-value guards in worker-side converter now use explicit `!= 0` checks instead of truthiness for resilience and clarity (#tts-alignment-review)
- `CTCAligner._ensure_model()` now thread-safe via double-checked locking pattern (#tts-alignment-review)
- DRY: `_extract_alignment` and `_extract_normalized_alignment` in kokoro.py refactored to share token timing extraction logic (#tts-alignment-review)
- DRY: `inspect.iscoroutine` resolve pattern extracted to `_resolve_stream()` helper in interface.py, replacing 4 duplicate occurrences (#tts-alignment-review)
- Forced alignment full-buffer trade-off documented with prominent comment and `forced_alignment_full_buffer` log event in servicer (#tts-alignment-review)
- TTS servicer `Synthesize` method decomposed into three focused private methods: `_synthesize_standard`, `_synthesize_native_alignment`, `_synthesize_forced_alignment` — dispatcher now routes by strategy pattern (#tts-alignment-review)
- KokoroBackend: extracted `_validate_and_resolve()` shared validation method — eliminates duplicated input validation between `synthesize()` and `synthesize_with_alignment()` (#tts-alignment-review)
- TTS servicer: extracted `_encode_and_build_chunk()` helper — centralizes codec encoding logic previously duplicated across 3 strategy methods (#tts-alignment-review)
- `_tts_speak_task` refactored from 22 individual keyword arguments to `cmd: TTSSpeakCommand` Parameter Object — cleaner interface, future TTS fields auto-propagate (#tts-alignment-review)
- `include_alignment` Field description on `SpeechRequest` now documents NDJSON content-type switch behavior (#tts-alignment-review)
- `AlignmentStreamDone` now includes `alignment_available` feedback field — clients can detect when alignment was requested but engine couldn't provide it (#tts-alignment-review)
- All remaining Portuguese strings in codebase translated to English — catalog descriptions, demo UI/scripts, test docstrings/comments, Pydantic model descriptions, and notebook test text for international community adoption (#i18n)

### Fixed
- `seed` field on `SpeechRequest` and `TTSSpeakCommand` now validates `ge=1` — rejects 0 (proto3 wire default) and negative values at the API boundary, preventing silent no-ops (#tts-alignment-review)
- `POST /v1/audio/speech` alignment + format validation now runs before opening gRPC stream — invalid requests (e.g., `include_alignment=true` + `response_format=opus`) return 400 without leaking gRPC resources (#tts-alignment-review)
- `_distribute_timing_to_chars` degenerate case fixed — when word duration < number of characters, advance is now clamped to `max(per_char_ms, 1)` preventing overlapping offsets (#tts-alignment-review)
- `POST /v1/audio/speech` with `include_alignment=true` and `response_format=opus` now returns 400 instead of silently ignoring the codec (#tts-alignment-review)
- Qwen3 `text_normalization=off` with custom `instruction` now logs warning instead of silently discarding normalization-off intent (#tts-alignment-review)
- `SessionConfig.silence_timeout_ms` default was 300 (0.3s) but `SessionSettings.silence_timeout_s` default is 30.0 (30s) — 100x mismatch caused `session.created` to report incorrect timeout to clients (#32)
- DRY violations: preprocessing/postprocessing defaults duplicated between `config/settings.py` and `config/preprocessing.py`/`config/postprocessing.py` — now both import from `_audio_constants.py` single source of truth (#32)
- Blocking file I/O in `POST /v1/audio/speech` when resolving saved voice ref_audio — now uses `asyncio.to_thread()` to avoid blocking the event loop (#32)
- Kokoro TTS `repo_id` was hardcoded to `"hexgrad/Kokoro-82M"` — now configurable via engine_config in macaw.yaml manifest (#32)
- `macaw ps` CLI command used hardcoded 10s timeout instead of configured `MACAW_HTTP_TIMEOUT_S` (120s default) — caused inconsistent timeout behavior vs `macaw transcribe` (#hardcode-audit-v6)
- `make audit` failed on unpushed commits — `pip-audit` tried to git-fetch the local editable install's commit SHA from the remote; now excludes editable installs from audit requirements (#hardcode-audit-v6)
- DRY violations: beam_size/accumulation_threshold defaults duplicated in faster_whisper.py, RTFx threshold duplicated in STT/TTS warmup, Silero chunk_size magic number, 8-bit PCM scale magic number (#hardcode-audit-v6)
- `session.configure` timeout fields (`silence_timeout_ms`, `hold_timeout_ms`) accepted but silently ignored — now wired through to `StreamingSession.update_session_timeouts()` (#review-v2-F12)
- `macaw ps` command broken — read wrong response keys (`models` instead of `data`, `name` instead of `id`), always showed "No models loaded" (#review-v2)
- Hot-path float64-to-float32 allocation in `DCRemoveStage.process()` — avoided unconditional `astype` copy on every audio frame (#review-v2)
- `SpeechRequest.input` accepted empty string — added `min_length=1` for proper 422 validation (#review-v2)
- `SpeechRequest.response_format` accepted any string — changed to `Literal["wav", "pcm"]` for Pydantic validation (#review-v2)
- `TTSSpeakCommand.text` had no length limit — added `min_length=1, max_length=4096` to prevent WebSocket abuse (#review-v2)
- `Qwen3TTSBackend._decode_ref_audio` silently fell back to int16 for unsupported WAV sample widths — now raises `AudioFormatError` (#review-v2)
- 9 Portuguese error messages in `ring_buffer.py` translated to English (#review-v2)
- `transcriptions` and `translations` endpoints: `model` field had no max_length, `temperature` had no bounds — added `max_length=256` and `ge=0.0, le=2.0` (#review-v2)
- mypy `NameError` risk in `cli/models.py` — renamed loop variable `e` to `entry` to avoid CPython except-bound variable deletion (#review-phase1)
- mypy `call-overload` error in `workers/tts/qwen3.py` — added explicit type narrowing for `ref_audio` in `_decode_ref_audio()` (#review-phase1)
- Swallowed exception in `Qwen3TTSBackend.voices()` — `except Exception` now captures and logs the error string (#review-phase1)
- Swallowed exception in `WorkerManager._health_probe()` — `except Exception: pass` replaced with `logger.debug` with `exc_info` (#review-phase1)
- GPU memory leak in `KokoroBackend.unload()` — now calls `del` on model/pipeline and `torch.cuda.empty_cache()`, matching Qwen3 behavior (#review-phase1)
- Missing VoiceStore null guard in `POST /v1/audio/speech` — requests with `voice_` prefix now raise `InvalidRequestError` when VoiceStore is not configured, instead of passing invalid voice ID to engine (#review-phase1)
- Wrong `type: ignore` code in `workers/stt/main.py` and `workers/tts/main.py` — changed from `arg-type` to `call-overload` (#review-phase1)
- Flaky test `test_semaphore_allows_parallel_when_higher` — replaced absolute timing assertion with relative comparison (parallel < 75% of serial), eliminating CI flakiness (#review-phase3)
- Portuguese error messages standardized to English across error handlers, worker factories, and WebSocket routes (#review-phase3)
- `logging.getLogger` in `vad/silero.py` replaced with `macaw.logging.get_logger` for consistent structured logging (#review-phase3)

### Changed
- `TextStage.process()` signature extended with optional `language` keyword parameter — backward compatible, existing stages ignore it (#32)
- `ITNStage` refactored from single-language to multi-language with `Dict[str, InverseNormalize]` lazy cache — eliminates need to restart runtime when switching languages (#32)
- `macaw serve --log-level` now propagates to uvicorn — previously uvicorn always ran at "warning" level regardless of CLI flag (#32)
- `macaw serve --cors-origins` now falls back to `MACAW_CORS_ORIGINS` env var when CLI flag is not provided (#32)
- Streaming STT inference uses named `_DEFAULT_TEMPERATURE` constant instead of magic `0.0` for consistency with batch path (#32)
- Metrics modules (`session/metrics.py`, `scheduler/metrics.py`, `scheduler/tts_metrics.py`) use `NullMetric` fallback instead of `None` when prometheus_client is not installed — eliminates ~22 `if metric is not None:` guards across hot-path files (#review-v3-4.4)
- `list_voices()` in `FileSystemVoiceStore` batched into single `asyncio.to_thread()` call via `_list_voices_sync()` — N voices = 1 thread submission instead of N (#review-v3-4.7)
- All Portuguese docstrings, comments, and error messages translated to English for consistency (#review-v3-4.9)
- Extracted shared `torch_utils.py` — `configure_cuda_env()` and `configure_torch_inference()` deduplicated from STT/TTS worker mains into a single shared module (#review-phase2)
- Extracted shared `proto_utils.py` — `build_health_response()` deduplicated from STT/TTS converters (#review-phase2)
- Introduced `WorkerType` enum in `workers/manager.py` — replaced primitive string obsession (`"stt"`, `"tts"`) with a proper enum for type safety (#review-phase2)
- Extracted TTS service facade (`tts_service.py`) — `resolve_tts_resources()` and `find_default_tts_model()` consolidated from `speech.py` and `realtime.py` (#review-phase2)
- Extracted gRPC channel management (`grpc_channels.py`) — `get_or_create_tts_channel()` and `close_tts_channels()` moved from `speech.py` route module (#review-phase2)
- Consolidated gRPC constants in `server/constants.py` — `TTS_GRPC_CHANNEL_OPTIONS` and `TTS_GRPC_TIMEOUT` centralized, eliminating duplicate magic numbers (#review-phase2)
- Extracted `_drain_stream()` in `StreamingSession` — 3 duplicate stream cleanup sites consolidated into a single method (#review-phase2)
- Extracted `_send_to_worker()` in `Scheduler` — unified proto build + gRPC call + error translation, removing ~25 lines of duplication (#review-phase2)
- Decomposed `StreamingSession` god class (1083 → 847 lines) — extracted `StreamMetricsRecorder` (84 lines, owns TTFB/final_delay/force-commit timing) and `StreamRecoveryHandler` (139 lines, owns crash recovery + WAL resend) (#review-phase3)
- Added `update_itn()` public method to `StreamingSession` — `realtime.py` no longer mutates private `_enable_itn` directly (#review-phase3)
- Health check `_check_worker_health()` refactored from if/else to dispatch table — adding a new worker type requires one function + one dict entry (#review-phase3)
- Stale gRPC channels now evicted on error in `Scheduler._dispatch_request()` — next request creates a fresh channel instead of broken one (#review-phase3)
- Consolidated duplicate VAD methods `_compute_timestamp_ms` / `_samples_to_ms` into single `_samples_to_ms` in `vad/detector.py` (#review-phase3)
- Migrated from src layout to flat layout (`src/macaw/` → `macaw/`) — simpler project structure, zero import changes (#flat-layout)

### Removed
- ~22 metric guard checks (`if HAS_METRICS and metric is not None:`) from `streaming.py`, `realtime.py`, and `scheduler.py` — replaced by Null Object pattern (#review-v3-4.4)
- 3 stale TODO comments from `cli/serve.py`, `workers/stt/main.py`, `workers/tts/main.py` — speculative future work that doesn't warrant tracking (#review-v3-4.8)
- Dead code: `TTSSpeechResult` dataclass and `tts_proto_chunks_to_result()` function — superseded by `StreamingResponse` in TTS endpoint (#review-v2-F16)
- Unused `sensitivity` parameter from `VADDetector.__init__` — thresholds are set in the injected `EnergyPreFilter` and `SileroVADClassifier` components (#review-v2-F22)
- Dead code: `CreateVoiceRequest` model, `ErrorResponse`/`ErrorDetail` models, `_sensitivity` field in VAD detector, `_pending_final_event` in StreamingSession, YAGNI preprocessing config fields (#review-phase3)

### Added
- Unit tests for `error_handlers.py` — 14 tests covering all 10 exception handlers with status codes, response format, and Retry-After headers (#review-phase3)
- Endpoint `GET /v1/voices` listing available TTS voices from loaded workers via gRPC ListVoices RPC, aggregated across all TTS models (#voices)
- Endpoint `POST /v1/voices` for creating saved voices (cloned with ref_audio upload or designed with instruction text) via multipart/form-data (#voices)
- Endpoint `GET /v1/voices/{id}` for retrieving saved voice details (#voices)
- Endpoint `DELETE /v1/voices/{id}` for removing saved voices (#voices)
- `VoiceStore` ABC with `FileSystemVoiceStore` implementation for persisting cloned and designed voices on disk (#voices)
- `VoiceNotFoundError` exception mapped to HTTP 404 in error handlers (#voices)
- Saved voice resolution in `POST /v1/audio/speech` — voices prefixed with `voice_` are looked up from VoiceStore and their params (ref_audio, ref_text, instruction) injected into the request (#voices)
- `ListVoices` RPC in TTS worker proto with `VoiceInfoProto` message type (#voices)
- ADR-001: Voice Persistence Architecture — filesystem-based VoiceStore at API layer (#adrs)
- ADR-002: Audio Watermarking for Voice Cloning — proposed design, deferred implementation (#adrs)
- `demo_voice_cloning.py` — Gradio web demo for voice cloning interativo com Qwen3-TTS-0.6B-Base: upload/gravacao de audio de referencia, selecao de idioma, sintese com voz clonada (#demo)
- Endpoint HTTP `GET /v1/realtime` retorna 426 Upgrade Required com documentação completa do protocolo WebSocket no Swagger UI — conexão, comandos, eventos, full-duplex e exemplos JSON (#docs)
- CLI `macaw catalog` para listar modelos disponiveis para download no catalogo, com tabela formatada (NAME, TYPE, ENGINE, DESCRIPTION) (#catalog)
- `macaw pull` instala automaticamente as dependencias da engine do modelo apos download — engines com extras opcionais (faster-whisper, kokoro, qwen3-tts) sao instaladas via pip sem intervencao manual (#pull)
- Qwen3-TTS backend com suporte a CustomVoice (9 vozes preset), Base (voice cloning), e VoiceDesign (instrucao em linguagem natural) (#qwen3-tts)
- 5 modelos Qwen3-TTS no catalogo: 0.6B/1.7B CustomVoice, 0.6B/1.7B Base, 1.7B VoiceDesign (#qwen3-tts)
- Campos opcionais `language`, `ref_audio`, `ref_text`, `instruction` na API REST e WebSocket para suportar TTS LLM-based (#qwen3-tts)
- End-to-end demo notebook (`e2e_test.ipynb`) covering all CLI commands, REST API endpoints, and WebSocket protocols — client-facing, zero internal imports (#e2e)
- Website (usemacaw.io) and contact email (hello@usemacaw.io) documented across README, docs site, contributing guides, and security policy (#docs)
- CNAME file for GitHub Pages custom domain (`docs.usemacaw.io`) (#docs)
- DNS setup guide (`docs/DNS_SETUP.md`) for migrating docs to `docs.usemacaw.io` (#docs)

### Fixed
- Qwen3-TTS voice cloning falhava com `TypeError: Unsupported audio input type: <class 'bytes'>` — `ref_audio` bytes (WAV) agora são decodificados para `(np.ndarray, sample_rate)` antes de passar ao modelo, compatível com a API `qwen_tts` (#voice-cloning)
- `src/uvicorn.py` (test shim) sombreava o pacote real `uvicorn` quando `PYTHONPATH=src`, causando `ModuleNotFoundError: No module named 'uvicorn.config'` — movido para `tests/uvicorn_shim.py` (#dev)
- WebSocket `/v1/realtime` não processava áudio — `StreamingGRPCClient` nunca era instanciado durante `macaw serve`, fazendo com que todas as sessões streaming descartassem frames silenciosamente. Agora o cliente gRPC streaming é criado e conectado ao worker STT no startup (#streaming)
- Workers gRPC (STT e TTS) rejeitavam keepalive pings do runtime com `GOAWAY ENHANCE_YOUR_CALM` — servidores gRPC agora aceitam pings a cada 5s, compatível com o intervalo de 10s do cliente streaming (#streaming)
- Silero VAD exibia mensagem de erro enganosa "requires torch" quando `torchaudio` estava ausente — agora diferencia a falta de `torch` da falta de dependências do Silero e mostra a mensagem correta (#vad)
- CLI `macaw transcribe --format verbose_json` exibia apenas o texto puro em vez do JSON completo com segmentos, timestamps e idioma — agora retorna o objeto JSON completo para `verbose_json` (#cli)
- Modelos Faster-Whisper no catálogo usavam `compute_type: "float16"` hardcoded, causando crash do worker STT em máquinas sem GPU — alterado para `compute_type: "auto"` que seleciona o tipo ideal automaticamente (float16 em GPU, int8 em CPU) (#catalog)
- `macaw serve` não tenta mais spawnar workers para engines não instaladas — modelos com dependência opcional ausente são pulados com warning claro indicando o comando de instalação (#serve)
- Protobuf stubs (`*_pb2.py`) ausentes no wheel PyPI causavam `ModuleNotFoundError` ao rodar `macaw serve` — adicionado hatch build hook que gera os stubs automaticamente durante o build (#build)
- Kokoro TTS `languages` no catálogo listava apenas 3 idiomas (en, pt, ja) mas o backend suporta 8 — atualizado para en, es, fr, hi, it, ja, pt, zh (#catalog)
- `GET /health` reportava `status: "ok"` antes dos workers gRPC estarem prontos, causando race condition onde requests TTS falhavam com 503 logo após o servidor iniciar — agora retorna `status: "loading"` enquanto workers estão iniciando e `status: "degraded"` se algum crashou (#health)

### Removed
- WeNet STT backend removido — engine, testes, manifesto, dependencia opcional e documentacao (#wenet-removal)

### Changed
- Extra `[stream]` agora inclui `torch` e `torchaudio` como dependências — `pip install macaw-openvoice[stream]` instala tudo necessário para streaming via WebSocket, incluindo Silero VAD (#deps)
- `POST /v1/audio/speech` agora usa `StreamingResponse` — audio chunks são enviados ao cliente conforme chegam do gRPC worker, reduzindo TTFB significativamente (#perf)
- TTS gRPC channel é reutilizado entre chamadas `tts.speak` na mesma conexão WebSocket — elimina overhead de TCP+HTTP/2 handshake (~5-20ms por request) (#perf)
- Float32→int16 conversion no audio pipeline usa operações NumPy in-place (`np.multiply(out=)`, `np.clip(out=)`) — reduz alocações de 4 para 2 por frame no hot path (#perf)
- gRPC streaming channel inclui `grpc.http2.max_pings_without_data=0` — previne morte silenciosa de conexão durante períodos de mute-on-speak (#perf)
- `LatencyTracker.cleanup()` é chamado periodicamente pelo Scheduler dispatch loop (a cada 30s) — previne memory leak em requests que nunca completam (#perf)
- KokoroBackend `synthesize()` agora usa true streaming via `asyncio.Queue` — cada segmento do KPipeline é convertido para PCM e yielded imediatamente, reduzindo TTFB de tempo-total-de-síntese para tempo-do-primeiro-segmento (#perf)
- Int16→float32 conversion no `StreamingPreprocessor` usa divisão in-place (`/=`) — elimina 1 array temporário por frame no hot path STT (#perf)
- `EnergyPreFilter.is_silence()` usa `np.dot()` para RMS e operações in-place para spectral flatness — elimina 3 arrays temporários por frame no pre-filter VAD (#perf)
- FasterWhisperBackend `beam_size` agora lido de `engine_config` em vez de hardcoded=5 — permite tuning via `macaw.yaml` manifest (#perf)
- Workers STT e TTS executam dummy inference (warmup) após `load()` — GPU caches e JIT são primados antes do primeiro request real, reduzindo latência da primeira inferência (#perf)
- `docker-compose.yml` agora inclui `deploy.resources` com limites de memória (4G) e CPU (4 cores) — previne OOM killer em ambientes compartilhados (#infra)
- `fastapi`, `uvicorn`, `python-multipart` e `huggingface_hub` movidos de extras opcionais para dependências base — `pip install macaw-openvoice` agora inclui tudo necessário para `macaw serve` funcionar (#deps)
- TTSBackend.synthesize() agora aceita `options: dict` opcional para params engine-specific (#qwen3-tts)
- Docusaurus config prepared for custom domain migration to `docs.usemacaw.io` (#docs)
- Imagem Docker CPU agora é apenas `linux/amd64` — `pynini` (dependência de ITN) não publica wheels arm64 e requer OpenFst compilado from source (#release-ci)

### Fixed
- Malformed security email in SECURITY.md (`security@usemacawcom` corrected to `hello@usemacaw.io`) (#docs)
- Build de imagens Docker falhava porque `cdifflib` (dependência transitiva de `nemo-text-processing`) requer compilador C — adicionado `gcc`/`g++` no builder stage dos Dockerfiles CPU e GPU (#release-ci)
- Testes de integração falhavam no CI porque o job não instalava o extra `faster-whisper` — adicionado `.[dev,grpc,faster-whisper]` no job integration (#ci)
- Build da imagem Docker GPU falhava porque Ubuntu 22.04 não tem Python 3.12 nos repos oficiais — adicionado PPA `deadsnakes` nos stages builder e runtime (#release-ci)
- Build da imagem Docker GPU falhava porque `pip` do sistema (Python 3.10) não funciona com Python 3.12 (`distutils` removido) — substituído por `python3.12 -m ensurepip` + `python3.12 -m pip` e removido `python3-pip` do apt (#release-ci)
- Protobuf runtime passa a ser instalado por padrão para evitar mismatch com stubs gerados (#deps)

## [0.1.7] - 2026-02-12

### Added
- Cache de pip no CI para acelerar builds (#release-ci)
- Job de testes de integração separado no CI (#release-ci)
- Verificação de segurança com pip-audit no CI e release (#release-ci)
- One-command installer for Linux/macOS via `curl | sh` using `uv` as backbone (#install-scripts)
- One-command installer for Windows via `irm | iex` using `uv` as backbone (#install-scripts)
- Docker image build script for CPU and GPU (multi-arch linux/arm64,linux/amd64) (#install-scripts)
- Linux distribution build script producing pip wheel + Docker images (#install-scripts)
- Shared build environment script `scripts/env.sh` with VERSION, PLATFORM, DOCKER_REPO vars (#install-scripts)
- Root `install.sh` redirect to `scripts/install.sh` for quick install UX (#install-scripts)
- NVIDIA GPU detection in install scripts with automatic `faster-whisper` extras installation (#install-scripts)
- systemd service setup for Linux installs (configurable via `Macaw_NO_SERVICE`) (#install-scripts)
- Windows uninstall support via `Macaw_UNINSTALL=1` environment variable (#install-scripts)
- PyPI publish via OIDC trusted publisher in release workflow (#release-ci)
- Docker image build and push to GHCR in release workflow: CPU multi-arch (amd64+arm64) and GPU (amd64) (#release-ci)
- Open-source community files (CODE_OF_CONDUCT.md, SECURITY.md) (#release-oss)
- GitHub issue and pull request templates (#release-oss)
- Docusaurus documentation site scaffold with initial content (#release-oss)

### Changed
- Default Docker registry in `scripts/env.sh` from Docker Hub to GHCR (`ghcr.io/useMacaw/Macaw-openvoice`) (#release-ci)

### Removed
- Ollama-specific build scripts: `build_darwin.sh`, `build_windows.ps1`, `deduplicate_cuda_libs.sh` (#install-scripts)
- Ollama-specific deploy scripts: `tag_latest.sh`, `push_docker.sh`, `.this-is-the-create-dmg-repo` (#install-scripts)

### Fixed
- Corrigido namespace Docker inconsistente no release.yml (useMacaw -> usemacaw) para CPU e GPU builds (#release-ci)
- Corrigido caminho do volume de modelos nos Dockerfiles (/root/.Macaw -> /root/.macaw) (#release-ci)
- Package metadata layout in `pyproject.toml` to keep dependencies out of `project.urls` (#release-oss)
- Restored `scripts/generate_proto.sh` for CI proto stub verification (#release-oss)
- Mypy config for optional dependencies in CI (FastAPI, Prometheus, Uvicorn) (#release-oss)
- Mypy overrides for optional runtime integrations (Silero torch hub, websockets client) (#release-oss)
- Proto stub imports now use package-relative paths for CI test discovery (#release-oss)
- Dev dependencies now include FastAPI/Starlette for unit tests (#release-oss)
- Dev dependencies now include python-multipart for FastAPI form parsing in tests (#release-oss)
- Dev dependencies now include prometheus_client and huggingface_hub for unit tests (#release-oss)
- Added GitHub Actions workflows for Docusaurus test/deploy to Pages (#release-oss)
- Added .nojekyll and trailingSlash config for GitHub Pages deployment (#release-oss)

## [0.1.0] - 2026-02-10

### Added
- Proto `tts_worker.proto` defining TTSWorker service with `Synthesize` (server-streaming) and `Health` (unary), messages `SynthesizeRequest`, `SynthesizeChunk` and `HealthResponse` (#M9-02)
- Generated and committed protobuf stubs for TTS: `tts_worker_pb2.py`, `tts_worker_pb2_grpc.py`, `tts_worker_pb2.pyi` (#M9-02)
- Re-exports of TTS messages and services in `macaw.proto.__init__`: `SynthesizeRequest`, `SynthesizeChunk`, `TTSHealthRequest`, `TTSHealthResponse`, `TTSWorkerServicer`, `TTSWorkerStub`, `add_TTSWorkerServicer_to_server` (#M9-02)
- `TTSWorkerServicer` gRPC with `Synthesize` (server-streaming: text in, PCM chunks out) and `Health` (unary), empty text validation, duration estimation per chunk, cancellation detection (#M9-02)
- `SynthesizeParams` typed dataclass for safe conversion of `SynthesizeRequest` proto to backend parameters (#M9-02)
- Pure TTS converters in `macaw.workers.tts.converters`: `proto_request_to_synthesize_params()`, `audio_chunk_to_proto()`, `health_dict_to_proto_response()` (#M9-02)
- TTS worker entry point as subprocess: `python -m macaw.workers.tts` with argparse, default port 50052, factory `_create_backend()` with engine "kokoro" (#M9-02)
- 25 unit tests for TTS worker covering: Synthesize happy path (4), errors (4), Health (3), converters (4), proto roundtrip (4), factory (2), parse_args (2) (#M9-02)
- `KokoroBackend` implementing `TTSBackend` ABC for Kokoro engine: text-to-audio synthesis in PCM 16-bit with streaming in 4096-byte chunks (~85ms at 24kHz) (#M9-03)
- Pure helper functions for KokoroBackend: `_resolve_device()`, `_synthesize_with_model()`, `_extract_audio_array()` (supports ndarray, dict and object), `_float32_to_pcm16_bytes()` with clipping protection (#M9-03)
- Manifest fixture `tests/fixtures/manifests/valid_tts_kokoro.yaml` for KokoroBackend tests (#M9-03)
- 38 unit tests for KokoroBackend covering: health, load (success, missing library, failure, auto device), synthesize (chunks, chunk size, empty text, model not loaded, parameters, errors, dict/object result), voices, unload, resolve device, extract audio array, float32 to PCM16 (#M9-03)
- Endpoint `POST /v1/audio/speech` for TTS synthesis compatible with OpenAI Audio API contract (#M9-04)
- Pydantic `SpeechRequest` model with field validation: model, input, voice, response_format, speed (#M9-04)
- Helper `_synthesize_via_grpc()` for gRPC communication with TTS worker via server-streaming (#M9-04)
- PCM-to-WAV conversion via `_pcm_to_wav()` for WAV response format (#M9-04)
- TTS converters in `macaw.scheduler.tts_converters`: `build_tts_proto_request()` and `tts_proto_chunks_to_result()` (#M9-04)
- `TTSSpeakCommand` and `TTSCancelCommand` as client commands for TTS via WebSocket (#M9-05)
- `TTSSpeakingStartEvent` and `TTSSpeakingEndEvent` as server events for TTS synthesis status (#M9-05)
- `model_tts` field in `SessionConfig` and `SessionConfigureCommand` for per-session TTS model selection (#M9-05)
- Async function `_tts_speak_task()` in realtime endpoint for background TTS synthesis (#M9-05)
- `mute()` and `unmute()` methods in `StreamingSession` for mute-on-speak during TTS (#M9-06)
- `is_muted` property in `StreamingSession` for mute state query (#M9-06)
- `stt_muted_frames_total` Prometheus Counter in `macaw.session.metrics` for frames discarded during mute (#M9-06)
- Full-duplex integration in realtime endpoint: `tts.speak` triggers mute -> TTS synthesis -> audio chunks -> unmute (#M9-07)
- `tts.cancel` support: cancels active TTS task and unmutes STT immediately (#M9-07)
- Automatic cancellation of previous TTS when new `tts.speak` arrives (#M9-07)
- TTS error handling: failures emit `error` event with `recoverable: true` and unmute STT (#M9-07)
- 22 tests in `test_full_duplex.py` covering speak, cancel, mute cycle, error recovery and edge cases (#M9-07)
- `Macaw_tts_ttfb_seconds` Histogram for TTS Time to First Byte (#M9-08)
- `Macaw_tts_synthesis_duration_seconds` Histogram for total TTS synthesis duration (#M9-08)
- `Macaw_tts_requests_total` Counter with `status` label (ok/error/cancelled) for TTS requests (#M9-08)
- `Macaw_tts_active_sessions` Gauge for sessions with active TTS (#M9-08)
- `HAS_TTS_METRICS` flag in `macaw.scheduler.tts_metrics` with lazy import pattern (#M9-08)
- 16 tests in `test_tts_metrics.py` covering metric types, availability and instrumentation (#M9-08)
- 21 tests in `test_speech_e2e.py` for REST TTS endpoint: happy path, errors and edge cases (#M9-09)
- 17 tests in `test_full_duplex_integration.py` for full-duplex lifecycle, sequential operations, error recovery and edge cases (#M9-09)
- ~192 new tests for M9 (cumulative total: 1600 tests) (#M9-09)
- `SchedulerQueue` com fila de prioridade de dois niveis (REALTIME > BATCH), FIFO dentro do mesmo nivel, aging que promove BATCH apos threshold configuravel (default 30s) (#M8-01)
- `RequestPriority` enum (REALTIME=0, BATCH=1) e `ScheduledRequest` dataclass com cancel_event, enqueue_time e result_future (#M8-01)
- Dispatch loop assincrono no `Scheduler`: background `asyncio.Task` consome fila, despacha para workers via gRPC, resolve futures (#M8-02)
- Pool de canais gRPC no Scheduler com reuso por worker address (#M8-02)
- `Scheduler.submit()` para enfileirar requests com prioridade e obter `asyncio.Future` (#M8-02)
- `CancellationManager` para rastreamento e cancelamento de requests batch: cancel na fila (<1ms) e cancel em execucao via gRPC Cancel RPC (#M8-03, #M8-04)
- Propagacao de cancelamento via `cancel_in_flight()` com gRPC Cancel RPC e timeout de 100ms (#M8-04)
- `BatchAccumulator` para acumulacao de requests BATCH: agrupa por ate 50ms ou max_batch_size, despacha via `asyncio.gather()` (#M8-05)
- `Scheduler._dispatch_batch()` para despacho paralelo de batch de requests ao mesmo worker (#M8-06)
- `LatencyTracker` com timestamps por fase (enqueue, dequeue, grpc_start, complete), TTL cleanup e `LatencySummary` frozen dataclass (#M8-07)
- 7 metricas Prometheus do Scheduler com lazy import: `scheduler_queue_depth` (Gauge), `scheduler_queue_wait_seconds`, `scheduler_grpc_duration_seconds`, `scheduler_cancel_latency_seconds`, `scheduler_batch_size` (Histograms), `scheduler_requests_total` (Counter com labels priority+status), `scheduler_aging_promotions_total` (Counter) (#M8-08)
- Testes de integracao end-to-end do Scheduler: priorizacao, aging, cancelamento na fila e em execucao, batching, shutdown graceful, latency tracking (#M8-09)
- Testes de contencao do Scheduler: batch enfileirado durante realtime, anti-starvation, cancel durante contencao, acumulacao sob carga (#M8-09)
- 191 testes novos para M8 (total: 1408 testes) (#M8-09)

### Changed
- `scripts/generate_proto.sh` atualizado para compilar `tts_worker.proto` alem de `stt_worker.proto` com fix de import path (#M9-02)
- Ruff config: excluidos arquivos gerados `tts_worker_pb2*.py` do linting (#M9-02)
- Mypy config: override para `kokoro.*` (import opcional) (#M9-02)
- Dependencia opcional `kokoro` adicionada ao `pyproject.toml`: `pip install Macaw-openvoice[kokoro]` (#M9-02)
- `create_app()` factory aceita parametro `worker_manager` para lifecycle de workers TTS (#M9-04)
- Rota `speech.py` registrada no `app.py` para endpoint TTS (#M9-04)
- `dispatch_message()` em `ws_protocol.py` estendido para tratar comandos `tts.speak` e `tts.cancel` (#M9-05)
- Endpoint WebSocket `/v1/realtime` agora suporta full-duplex STT+TTS na mesma conexao (#M9-05)
- `StreamingSession.process_frame()` retorna imediatamente quando muted, pulando preprocessing e VAD (#M9-06)
- `_tts_speak_task()` chama `session.mute()` antes da sintese TTS e `session.unmute()` no bloco finally (#M9-06)
- `Scheduler` evoluido de round-robin trivial (M3) para async dispatch loop com fila de prioridade, cancelamento, batching e metricas (#M8-02)
- `Scheduler.transcribe()` mantem mesma assinatura externa para backward compatibility com API Server (#M8-02)
- Graceful shutdown do Scheduler: `stop()` drena in-flight requests, flush pending batches, cancela dispatch loop (#M8-02)

- `WeNetBackend` implementando `STTBackend` ABC para engine WeNet com arquitetura CTC: transcricao batch via `transcribe_file()` e streaming via `transcribe_stream()` com partials nativos (#M7-01, #M7-02)
- Manifesto `macaw.yaml` para WeNet CTC com `architecture: ctc`, `hot_words: true`, `initial_prompt: false`, `word_timestamps: true` (#M7-03)
- Registro do WeNet na factory `_create_backend()` com lazy import para evitar dependencia obrigatoria de `wenet` (#M7-03)
- Flag `--engine wenet` no CLI do worker STT para iniciar subprocess com WeNetBackend (#M7-06)
- Hot words via keyword boosting nativo do WeNet: `WeNetBackend` passa hot words como parametro de decoding (#M7-04)
- Pipeline adaptativo por arquitetura no `StreamingSession`: CTC usa partials nativos (sem LocalAgreement), nao atualiza cross-segment context, nao injeta initial_prompt (#M7-05)
- Metodo `_build_initial_prompt()` no `StreamingSession` com logica por arquitetura: encoder-decoder usa context + hot words; CTC usa apenas hot words sem suporte nativo (#M7-05)
- Testes comparativos de contrato: mesma sessao WebSocket com Whisper e WeNet produz eventos identicos (`transcript.partial`, `transcript.final`, `session.created`, `session.closed`) (#M7-07)
- Testes de streaming avancados com CTC: sequencia partial->final, WAL checkpoint, ring buffer commit, state machine funcional com arquitetura CTC (#M7-08)
- Fixture `valid_stt_wenet_manifest_path` no `conftest.py` para testes que usam manifesto WeNet (#M7-03)
- Dependencia opcional `wenet` no `pyproject.toml`: `pip install Macaw-openvoice[wenet]` (#M7-10)
- Documentacao `docs/ADDING_ENGINE.md` com guia de 5 passos para adicionar nova engine STT, exemplos de codigo do WeNet, checklist por passo, diagrama ASCII e FAQ com 9 perguntas (#M7-09)
- Secao 4.5.1 "Arquitetura Multi-Engine" no `docs/ARCHITECTURE.md` com tabela de implementacoes, diagrama de extensibilidade, factory pattern e comparacao por arquitetura (#M7-09)

### Added
- `SessionStateMachine` com 6 estados (INIT, ACTIVE, SILENCE, HOLD, CLOSING, CLOSED), transicoes validas, timeouts configuraveis e callbacks on_enter/on_exit (#M6-01)
- `SessionTimeouts` dataclass com defaults do PRD (INIT: 30s, SILENCE: 30s, HOLD: 5min, CLOSING: 2s) e validacao de timeout minimo de 1s (#M6-02)
- Funcao `timeouts_from_configure_command()` para converter campos do `SessionConfigureCommand` (ms) para `SessionTimeouts` (s) (#M6-02)
- `RingBuffer` com array pre-alocado de 60s, ponteiros circulares read/write, read fence e force commit em 90% de capacidade (#M6-04)
- Metodos `check_timeout()` e `update_session_timeouts()` no `StreamingSession` para verificacao periodica de timeouts da state machine (#M6-03)
- Property `session_state` no `StreamingSession` expondo estado atual da maquina de estados (#M6-03)
- Emissao de `SessionHoldEvent` com `hold_timeout_ms` correto quando sessao transita para HOLD (#M6-03)
- 21 testes de integracao em `test_session_state_integration.py` cobrindo transicoes, timeouts, comportamento por estado e emissao de eventos (#M6-03)
- Integracao do Ring Buffer no `StreamingSession`: frames preprocessados escritos no buffer, read fence avanca em transcript.final, force commit automatico quando buffer >90% cheio (#M6-05)
- 32 testes em `test_ring_buffer_fence.py` cobrindo read fence, commit, uncommitted bytes, write protection, force commit callback e integracao StreamingSession + Ring Buffer (#M6-05)
- `SessionWAL` (Write-Ahead Log in-memory) com `WALCheckpoint` frozen dataclass para recovery de sessao sem duplicacao apos crash de worker (#M6-06)
- Integracao do WAL no `StreamingSession`: checkpoint registrado automaticamente apos cada transcript.final com segment_id, buffer_offset e timestamp monotonic (#M6-06)
- Property `wal` no `StreamingSession` para acesso ao WAL pela logica de recovery (#M6-06)
- 17 testes em `test_session_wal.py` cobrindo inicializacao, record/overwrite de checkpoints, imutabilidade do WALCheckpoint e integracao StreamingSession + WAL (#M6-06)
- `LocalAgreementPolicy` para confirmacao de partial transcripts em engines encoder-decoder via comparacao posicional entre passes consecutivas (#M6-08)
- `AgreementResult` dataclass imutavel com tokens confirmados, retidos e flag de nova confirmacao (#M6-08)
- 27 testes em `test_local_agreement.py` cobrindo agreement basico, crescimento monotonico, flush, reset, min_confirm_passes, edge cases e imutabilidade (#M6-08)
- `CrossSegmentContext` para continuidade entre segmentos de fala via initial_prompt com ultimos 224 tokens do transcript.final anterior (#M6-09)
- Integracao do CrossSegmentContext no `StreamingSession`: texto pos-processado (ITN) do transcript.final armazenado automaticamente; initial_prompt combina hot words e contexto no primeiro frame de cada segmento (#M6-09)
- 20 testes em `test_cross_segment_context.py` cobrindo armazenamento, truncamento, reset, integracao com StreamingSession e combinacao de hot words + contexto (#M6-09)
- Recovery de crash do worker via `StreamingSession.recover()`: reabre stream gRPC com timeout, reenvia dados nao commitados do ring buffer, restaura segment_id do WAL, inicia nova receiver task (#M6-07)
- Deteccao automatica de `WorkerCrashError` no receiver com emissao de erro recuperavel e tentativa de recovery transparente (#M6-07)
- 17 testes em `test_session_recovery.py` cobrindo abertura de novo stream, reenvio de uncommitted data, restauracao de segment_id, timeout, prevencao de recursao, integracao receiver+recovery e cenarios de falha (#M6-07)
- Hot words por sessao via `session.configure`: `StreamingSession` aceita `hot_words` que sao injetados como `initial_prompt` para Whisper no primeiro frame de cada segmento, combinados com cross-segment context (#M6-10)
- 9 testes em `test_hot_words_session.py` cobrindo injecao de hot words, formatacao de prompt, combinacao com cross-segment context e update via configure (#M6-10)
- 54 testes de integracao end-to-end em `test_m6_integration.py` cobrindo todos os componentes M6 juntos: state machine + ring buffer + WAL + recovery + cross-segment + hot words + force commit (#M6-11)
- Metricas Prometheus M6: `Macaw_stt_session_duration_seconds`, `Macaw_stt_segments_force_committed_total`, `Macaw_stt_confidence_avg`, `Macaw_stt_worker_recoveries_total` (#M6-13)
- 18 testes em `test_streaming_metrics.py` cobrindo registro de metricas de sessao, force commit, confidence e recovery (#M6-13)
- Teste de estabilidade de 30 minutos (simulado) com todos os componentes M6: state machine, ring buffer, WAL, cross-segment context, transicoes HOLD, force commit (#M6-15)
- Teste de force commit durante fala continua de 65s excedendo ring buffer de 60s (#M6-15)
- 3 testes de integracao de recovery end-to-end em `test_m6_recovery.py`: continuidade de segment_id, recovery com ring buffer vazio, multiplos recoveries na mesma sessao (#M6-16)

### Changed
- `StreamingSession` agora usa `SessionStateMachine` com 6 estados em vez do estado simplificado ACTIVE/CLOSED de M5 (#M6-03)
- Estado inicial da sessao agora e INIT (aguardando primeiro audio) em vez de ACTIVE (#M6-03)
- VAD speech_start transita INIT->ACTIVE, SILENCE->ACTIVE ou HOLD->ACTIVE (#M6-03)
- VAD speech_end transita ACTIVE->SILENCE (em vez de ser emitido incondicionalmente) (#M6-03)
- Frames recebidos em HOLD nao sao enviados ao worker gRPC (economia de GPU) (#M6-03)
- `check_inactivity()` agora delega para `SessionStateMachine.check_timeout()` em vez de usar timer fixo (#M6-03)
- `close()` agora transita via CLOSING->CLOSED pela state machine (#M6-03)

### Fixed
- SPEECH_END sem SPEECH_START previo nao emitia evento spurio -- agora e ignorado corretamente quando estado nao e ACTIVE (#M6-03)

### Added
- Endpoint WebSocket `WS /v1/realtime` com handshake (model, language, session_id) e protocolo de eventos JSON (#M5-T5-02)
- Pydantic models para 8 tipos de evento servidor e 4 tipos de comando cliente WebSocket (#M5-T5-01)
- Protocol handler `dispatch_message()` para dispatch tipado de frames binarios e comandos JSON (#M5-T5-03)
- Heartbeat WebSocket com ping a cada 10s e timeout de inatividade configuravel (#M5-T5-04)
- `EnergyPreFilter` com RMS + spectral flatness para pre-filtragem de silencio antes do Silero VAD (#M5-T5-05)
- `SileroVADClassifier` com lazy-loading do modelo Silero e sensitivity levels (high/normal/low) (#M5-T5-06)
- `VADDetector` coordenando energy pre-filter + Silero com debounce de fala (250ms) e silencio (300ms) (#M5-T5-07)
- `StreamingPreprocessor` adapter frame-by-frame para preprocessing de audio em streaming (#M5-T5-08)
- `StreamingGRPCClient` e `StreamHandle` para streaming gRPC bidirecional runtime-to-worker com crash detection via stream break (#M5-T5-09)
- `STTWorkerServicer.TranscribeStream` implementado como streaming gRPC bidirecional no worker (#M5-T5-10)
- Conversor `transcript_segment_to_proto_event()` para conversao proto de eventos de streaming (#M5-T5-10)
- `FasterWhisperBackend.transcribe_stream()` para transcricao streaming via acumulacao com threshold de 5s (#M5-T5-11)
- `StreamingSession` orquestrando fluxo completo: preprocessing -> VAD -> gRPC worker -> post-processing -> callback (#M5-T5-12)
- `BackpressureController` com sliding window para deteccao de envio mais rapido que real-time e drop de frames por backlog (#M5-T5-13)
- `StreamingSession.commit()` para force commit manual de segmento via `input_audio_buffer.commit` (#M5-T5-14)
- Metricas Prometheus para streaming: `Macaw_stt_ttfb_seconds`, `Macaw_stt_final_delay_seconds`, `Macaw_stt_active_sessions`, `Macaw_stt_vad_events_total` (#M5-T5-15)
- 218 testes unitarios cobrindo todos os componentes do M5: eventos, protocolo, heartbeat, VAD, preprocessor, gRPC, session, backpressure, metricas (#M5)
- 83 testes de edge cases para M5: frames vazios/oversized, JSON malformado, double close, use-after-close, debounce de VAD em fronteiras, backpressure com zero-byte frames, conversores proto com defaults, precedencia bytes vs text em WebSocket (#M5-T5-16)
- Teste de estabilidade de sessao de 5 minutos (simulada) validando ausencia de memory leak (<10MB) e degradacao de TTFB (<1.2x) (#M5-T5-18)
- Teste de estabilidade com 200 segmentos curtos validando ausencia de vazamento de recursos em ciclos rapidos de open/close de streams gRPC (#M5-T5-18)
- Property `name` na interface `TextStage` ABC para identificacao de stages no post-processing, simetrica com `AudioStage` (#M4-CR-F03)
- Logging por stage no `PostProcessingPipeline.process()` equivalente ao preprocessing pipeline (#M4-CR-F03)
- Re-exports de `AudioPreprocessingPipeline` e `AudioStage` no `macaw.preprocessing.__init__` via `__all__` (#M4-CR-F06)
- Script `scripts/demo_m4.sh` para demo end-to-end da Fase 1: preprocessing + post-processing + API + CLI (#M4-DEMO)

### Changed
- Endpoint WebSocket `/v1/realtime` agora integra `StreamingSession` completo: audio frames passam por backpressure -> preprocessing -> VAD -> gRPC worker -> post-processing (#M5-CR2-01)
- `VADDetector` agora faz debounce por total de samples acumulados em vez de contagem de frames, corrigindo calculo para frames de tamanho variavel (#M5-CR2-03)
- `BackpressureController.clock` tipado como `Callable[[], float]` em vez de `object` para type safety (#M5-CR2-02)
- `_create_streaming_session()` com tipo correto `Callable[[ServerEvent], Awaitable[None]]` para `on_event` (#M5-CR2-01)

### Fixed
- Endpoint WebSocket `/v1/realtime` descartava todos os audio frames recebidos sem processamento — agora integra pipeline completo via `StreamingSession` (#M5-CR2-01)
- Race condition em `StreamingSession._handle_speech_end()` onde `vad.speech_end` podia ser emitido antes de `transcript.final` — agora aguarda receiver task completar (#M5-CR2-02)
- Cancel RPC no servicer tinha mensagem de erro desatualizada referenciando M5 (#M5-CR2-03)
- `SileroVADClassifier._ensure_model_loaded()` nao era thread-safe — adicionado double-check locking com `threading.Lock` (#M5-CR2-05)
- `_handle_speech_start` agora limpa stream/receiver task anteriores antes de abrir novo stream, evitando leak de recursos em duplo SPEECH_START (#M5-CR-01)
- `_proto_event_to_transcript_segment` preserva `start_ms=0` e `end_ms=0` como valores validos em vez de converter para `None` incorretamente (#M5-CR-05)
- `_send_event` aceita qualquer `ServerEvent` em vez de apenas 3 tipos especificos (#M5-CR-02)
- `SessionConfigureCommand` rejeita timeouts negativos e zero com validacao `Field(gt=0)` (#M5-CR-03)
- `BackpressureController` usa duracao do primeiro frame (constante) em vez do frame atual para calculo de taxa efetiva (#M5-CR-08)
- `suppress(Exception)` no fechamento de WebSocket por inatividade restringido para `suppress(WebSocketDisconnect, RuntimeError, OSError)` (#M5-CR-14)
- Logs de `_send_event` agora incluem `session_id` para correlacao (#M5-CR-13)

### Added
- `SileroVADClassifier.preload()` metodo async que carrega o modelo em thread separada via `run_in_executor`, evitando bloqueio do event loop (#M5-CR-10)

### Fixed
- `Macaw serve` agora instancia pipelines de preprocessing e postprocessing com config toggles antes de criar a app — sem esse fix os pipelines ficavam `None` em producao (#M4-CR-F01)

### Added
- Interface abstrata `AudioStage` ABC para stages plugaveis do Audio Preprocessing Pipeline (#M4-E1-T1)
- Funcoes `decode_audio()` e `encode_pcm16()` para conversao entre bytes de audio e arrays numpy float32 (#M4-E1-T1)
- `AudioPreprocessingPipeline` que orquestra stages em sequencia: decode -> stages -> encode PCM16 WAV (#M4-E1-T1)
- 26 testes unitarios cobrindo AudioStage ABC, decode/encode de audio e pipeline de preprocessamento (#M4-E1-T1)
- `ResampleStage` para conversao de qualquer sample rate para 16kHz via `scipy.signal.resample_poly` (#M4-E1-T2)
- `DCRemoveStage` com filtro Butterworth HPF 2a ordem a 20Hz para remocao de DC offset (#M4-E1-T3)
- `GainNormalizeStage` com peak normalization para -3dBFS e protecao contra clipping (#M4-E1-T4)
- Integracao do Audio Preprocessing Pipeline no fluxo batch: audio preprocessado automaticamente antes do worker (#M4-E1-T5)
- Interface abstrata `TextStage` ABC para stages plugaveis do Post-Processing Pipeline (#M4-E2-T1)
- `PostProcessingPipeline` que orquestra stages de texto em sequencia com suporte a `BatchResult` imutavel (#M4-E2-T1)
- `ITNStage` para Inverse Text Normalization via `nemo_text_processing` com fallback graceful quando pacote nao instalado (#M4-E2-T2)
- Integracao do Post-Processing Pipeline no fluxo batch: texto formatado automaticamente apos transcricao (#M4-E2-T3)
- Parametro `itn` nos endpoints REST `/v1/audio/transcriptions` e `/v1/audio/translations` para controle de ITN por request (#M4-E3-T1)
- Flag `--no-itn` nos comandos CLI `Macaw transcribe` e `Macaw translate` para desabilitar ITN (#M4-E3-T1)
- Testes end-to-end validando pipeline completo: audio em qualquer sample rate -> preprocessing -> transcricao -> post-processing -> resposta formatada (#M4-E3-T2)
- FastAPI application factory `create_app()` com injecao de dependencias via Registry e Scheduler (#M3-E1)
- Endpoint `GET /health` retornando status e versao do runtime (#M3-E1)
- Endpoint `POST /v1/audio/transcriptions` compativel com contrato OpenAI Audio API (#M3-E3)
- Endpoint `POST /v1/audio/translations` com task=translate para traducao para ingles (#M3-E3)
- Pydantic models para request/response: `TranscriptionRequest`, `TranslationRequest`, `TranscriptionResponse`, `VerboseTranscriptionResponse` (#M3-E2)
- `ModelRegistry` para scan de modelos em disco, resolucao por nome e listagem de manifestos (#M3-E4)
- `Scheduler` basico que roteia requests para workers disponiveis e converte resultados (#M3-E5)
- Conversor `BatchResult` -> proto `TranscribeFileRequest` no scheduler (#M3-E5)
- Formatos de resposta: `json`, `verbose_json`, `text`, `srt`, `vtt` com formatters dedicados (#M3-E6)
- Error handlers HTTP: 400 (audio invalido), 400 (request invalido), 404 (modelo nao encontrado), 413 (arquivo grande), 503 (worker indisponivel), 500 (erro interno) com formato OpenAI-compatible (#M3-E7)
- `InvalidRequestError` na hierarquia de exceptions para parametros de request invalidos (#M3-CR1)
- CLI: `Macaw serve` — inicia API Server com workers gRPC para modelos STT instalados (#M3-E8)
- CLI: `Macaw transcribe <file>` — transcreve arquivo via HTTP com opcoes de formato, idioma e modelo (#M3-E8)
- CLI: `Macaw translate <file>` — traduz arquivo via HTTP com opcoes de formato e modelo (#M3-E8)
- CLI: `Macaw list` — lista modelos instalados com tabela formatada (nome, tipo, engine, arquitetura, memoria) (#M3-E8)
- CLI: `Macaw inspect <model>` — exibe detalhes completos de um modelo instalado (#M3-E8)
- Entry point `Macaw` via `pyproject.toml` scripts (#M3-E8)
- 18 testes end-to-end validando pipeline completo HTTP -> Scheduler(mock) -> Response para todos os formatos e cenarios de erro (#M3-E9)
- 4 testes de integracao validando compatibilidade com SDK `openai` Python como cliente real (#M3-E10)
- 25 testes unitarios para CLI (serve, transcribe, translate, list, inspect) (#M3-E8)
- Plano estrategico detalhado `docs/STRATEGIC_M3.md` com 5 entregas e 13 tasks (#M3-E0)
- Estrutura de projeto com `pyproject.toml`, src layout e extras opcionais (#M1-I1)
- Tooling: ruff (lint+format), mypy (strict), pytest com pytest-asyncio (#M1-I2)
- CI basico via GitHub Actions com matrix Python 3.11/3.12 (#M1-I3)
- Tipos fundamentais: `STTArchitecture`, `ModelType`, `SessionState`, `VADSensitivity`, `ResponseFormat`, `TranscriptSegment`, `BatchResult`, `EngineCapabilities` (#M1-I4)
- Hierarquia de exceptions tipadas por dominio: `MacawError`, `ConfigError`, `ModelError`, `WorkerError`, `AudioError`, `SessionError` (#M1-I5)
- Parsing e validacao de manifestos `macaw.yaml` via `ModelManifest` com Pydantic v2 (#M1-I6)
- Interface abstrata `STTBackend` ABC para engines STT plugaveis (#M1-I7)
- Protobuf gRPC `stt_worker.proto` com servico `STTWorker` (#M1-I7)
- Configuracoes de preprocessing e postprocessing com defaults (#M1-I6)
- Fixtures de teste: audio WAV (16kHz, 8kHz, 44.1kHz) e manifestos YAML (#M1-AUX)
- 56 testes unitarios cobrindo tipos, exceptions, manifesto, configs e contrato STTBackend (#M1-AUX)
- Pipeline de CD: workflow de release via tag `v*` com build de wheel e GitHub Release (#CD-01)
- Build validation no CI: verificacao de conteudo do wheel e consistencia de versao (#CD-02)
- Documentacao de CD pipeline com ADR-011 e estrategia de versionamento (#CD-03)
- Script `scripts/generate_proto.sh` para compilacao de protobuf com fix de import paths (#M2-I1)
- Stubs protobuf gerados e commitados: `stt_worker_pb2.py`, `stt_worker_pb2_grpc.py` (#M2-I1)
- Re-exports em `macaw.proto.__init__` para imports limpos de mensagens e servicos gRPC (#M2-I1)
- Structured logging via structlog com formatos JSON e console: `configure_logging()`, `get_logger()` (#M2-AUX)
- Conversores puros proto<->Macaw em `macaw.workers.stt.converters` (#M2-I2)
- gRPC servicer `STTWorkerServicer` com TranscribeFile, Health e stubs UNIMPLEMENTED (#M2-I2)
- Entry point de worker STT como subprocess: `python -m macaw.workers.stt` com argparse (#M2-I2)
- `FasterWhisperBackend` implementando `STTBackend` com transcricao batch, hot words via initial_prompt e conversao PCM->numpy (#M2-I3)
- `WorkerManager` para lifecycle de workers como subprocessos: spawn, health probe com backoff, crash detection, auto-restart com rate limiting e shutdown graceful (#M2-I4)
- 71 novos testes unitarios: converters (12), servicer (11), faster-whisper backend (21), worker manager (16), logging (6), integracao (5) (#M2-I5)
- Verificacao de freshness dos stubs proto no CI (#M2-I1)
- `WorkerCrashError` e `WorkerTimeoutError` na hierarquia de exceptions para erros de worker gRPC (#M3-CR6)
- Modulo `server/constants.py` com constantes centralizadas de limites e content-types (#M3-CR9)
- Modulo `server/routes/_common.py` com logica compartilhada entre rotas de audio (#M3-CR8)
- Testes para gRPC error translation: DEADLINE_EXCEEDED -> WorkerTimeoutError, UNAVAILABLE -> WorkerCrashError (#M3-CR6)
- Testes para HTTP 504 (WorkerTimeout) e 502 (WorkerCrash) nos error handlers (#M3-CR14)
- Testes para validacao de content-type em uploads de audio (#M3-CR10)
- Testes para timestamps negativos e segmentos vazios nos formatters SRT/VTT (#M3-CR22)
- Testes para campo `task` no scheduler e health endpoint com version/models_loaded (#M3-CR7)

### Changed
- Dependencias core: adicionados `click>=8.0` e `httpx>=0.27` para CLI e HTTP client (#M3-E8)
- Dependencias dev: adicionado `openai>=1.0` para testes de compatibilidade com SDK (#M3-E10)
- `pyproject.toml`: filtros de warnings para websockets DeprecationWarning e ResourceWarning (#M3-E10)
- Campos `compression_ratio` e `probability` adicionados aos tipos `SegmentDetail` e `WordTimestamp` (#M2-I0)
- Proto `Segment` e `Word` estendidos com campos `compression_ratio` e `probability` (#M2-I0)
- Dependencias core: adicionados `structlog>=24.0` e `numpy>=1.26` (#M2-I0)
- Dependencias dev: adicionado `types-grpcio>=1.0` para type stubs gRPC (#M2-I0)
- CI instala extras `dev,grpc` para suportar compilacao e testes de proto (#M2-I1)
- Ruff config: excluidos arquivos gerados `stt_worker_pb2*.py` do linting (#M2-I0)
- Mypy config: override para `faster_whisper.*` (import opcional) (#M2-I0)
- README: tabela de compatibilidade com endpoints OpenAI API (#README-01)
- README: secao Quick Start com exemplo minimo de uso (#README-02)
- README: diagrama de arquitetura convertido para Mermaid (#README-03)
- README: licenca atualizada de "A definir" para MIT (consistente com pyproject.toml) (#README-04)

### Fixed
- `response_format` invalido agora retorna 400 com mensagem descritiva em vez de 500 generico (#M3-CR1)
- Endpoints de transcricao e traducao agora rejeitam upload antes de ler arquivo quando `Content-Length` excede limite de 25MB (#M3-CR2)
- Formatters SRT e VTT agora fazem carry correto de milissegundos em timestamps de fronteira (ex: 59.9999s -> 00:01:00,000) (#M3-CR3)
- `STTWorkerServicer.TranscribeFile` agora tem return explicito apos `context.abort` evitando `UnboundLocalError` se abort nao levantar excecao (#M2-CR1)
- Logica duplicada de construcao de comando CLI no `WorkerManager` extraida para `_build_worker_cmd` e `_spawn_worker_process` (#M2-CR2)
- `_check_worker_health` moveu import de `STTWorkerStub` para fora do bloco try, evitando potencial leak de channel gRPC (#M2-CR3)
- Signal handler no worker STT agora protege contra duplo shutdown com flag `shutting_down` e funcao nomeada em vez de lambda (#M2-CR4)
- Background tasks do `WorkerManager` agora sao awaited apos cancel em `stop_worker` e removidas do dict via `_cancel_background_tasks` (#M2-CR5)
- Subprocess do worker usa `DEVNULL` em vez de `PIPE` para stdout/stderr, eliminando risco de deadlock quando worker gera output (#M2-CR6)
- `_attempt_restart` nao cancela mais as proprias background tasks (self-cancellation bug), substitui diretamente no dict (#M2-CR7)
- gRPC channel options no Scheduler: max_receive_message_length=30MB, keepalive_time=30s, keepalive_timeout=10s (#M3-CR4)
- gRPC timeout proporcional ao tamanho do audio no Scheduler: base 30s + 1s/MB (#M3-CR5)
- gRPC DEADLINE_EXCEEDED traduzido para `WorkerTimeoutError` e UNAVAILABLE para `WorkerCrashError` no Scheduler (#M3-CR6)
- Campo `task` agora propagado no proto `TranscribeFileRequest` para diferenciar transcribe/translate (#M3-CR7)
- Rotas de transcricao e traducao deduplicadas via modulo `_common.py` com `handle_audio_request()` (#M3-CR8)
- Constantes `MAX_FILE_SIZE_BYTES` e `ALLOWED_AUDIO_CONTENT_TYPES` centralizadas em `server/constants.py` (#M3-CR9)
- Content-type de upload validado contra frozenset de tipos permitidos antes de ler arquivo (#M3-CR10)
- Leitura de arquivo com limite `MAX_FILE_SIZE_BYTES + 1` para prevenir OOM em uploads sem Content-Length (#M3-CR11)
- Dependencias (`get_registry`, `get_scheduler`) agora fazem fail-fast com `InvalidRequestError` se None (#M3-CR12)
- Error handlers incluem `exc_info=True` e `request_id` para correlacao de logs (#M3-CR13)
- `WorkerTimeoutError` retorna HTTP 504 (Gateway Timeout) em vez de 503 generico (#M3-CR14)
- `WorkerCrashError` retorna HTTP 502 (Bad Gateway) com header `Retry-After: 5` (#M3-CR15)
- `Macaw serve` agora faz bind em `127.0.0.1` por default em vez de `0.0.0.0` (#M3-CR16)
- Shutdown graceful do CLI serve usa `loop.add_signal_handler` em vez de `signal.signal` para compatibilidade com asyncio (#M3-CR17)
- Worker stderr capturado via `subprocess.PIPE` e logado (ultimos 2000 chars) em caso de crash (#M3-CR18)
- Health endpoint retorna campo `version` (via `macaw.__version__`) e `models_loaded` quando registry disponivel (#M3-CR19)
- Versao do CLI centralizada via `macaw.__version__` eliminando string duplicada (#M3-CR20)
- `DEFAULT_MODELS_DIR` deduplicado entre `cli/serve.py` e `cli/models.py` (#M3-CR21)
- Formatters SRT e VTT agora ignoram segmentos com texto vazio/whitespace-only (#M3-CR22)
- Formatters SRT e VTT clampeiam timestamps negativos para zero (#M3-CR23)
- Conversor proto usa `probability` 0.0 como default em vez de campo ausente para `no_speech_prob` (#M3-CR24)
